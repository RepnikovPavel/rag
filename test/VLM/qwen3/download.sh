#!/usr/bin/env bash
# download_qwen3_vl_full.sh - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Qwen/Qwen3-VL-235B-A22B-Instruct
# –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ç–æ—á–Ω–æ–º —Å–ø–∏—Å–∫–µ —Ñ–∞–π–ª–æ–≤ (96 —à–∞—Ä–¥_weights)

set -euo pipefail

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
MODEL_ID="Qwen/Qwen3-VL-235B-A22B-Instruct"
# –ü–∞–ø–∫–∞, –∫—É–¥–∞ —Å–∫–∞—á–∏–≤–∞—Ç—å (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å ~480 –ì–ë –º–µ—Å—Ç–∞!)
TARGET_DIR="/mnt/nvme/huggingface/Qwen3-VL-235B-A22B-Instruct"

echo "üöÄ –°–∫–∞—á–∏–≤–∞–µ–º $MODEL_ID"
echo "üìÇ –ü–∞–ø–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: $TARGET_DIR"
echo "‚ö†Ô∏è  –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –ú–æ–¥–µ–ª—å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 96 —á–∞—Å—Ç–µ–π, –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä ~470 –ì–ë."

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É
mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
do_download() {
    local url="$1"
    local filename="$2"
    
    # –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –µ—Å—Ç—å –∏ –∏–º–µ–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Ä–≤–µ—Ä–æ–º (—á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ)
    if [[ -f "$filename" && ! -s "$filename" ]]; then
        echo "‚ö†Ô∏è  –§–∞–π–ª $filename —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—É—Å—Ç–æ–π. –£–¥–∞–ª—è—é..."
        rm "$filename"
    fi

    echo "üì• –°–∫–∞—á–∏–≤–∞—é: $filename"
    
    # Wget —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–∫–∞—á–∫–∏ (-c), —Ç–∞–π–º–∞—É—Ç–æ–º –∏ 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏
    wget -c --timeout=3600 --tries=3 --continue \
         --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
         -O "$filename" "$url" || {
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è $filename. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞."
        return 1
    }
}

# ---------------------------------------------------------
# –ß–ê–°–¢–¨ 1: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–µ—Å–æ–≤ (96 —Ñ–∞–π–ª–æ–≤ safetensors)
# ---------------------------------------------------------
echo "========================================"
echo "‚¨áÔ∏è  –ß–ê–°–¢–¨ 1: –í–µ—Å–∞ –º–æ–¥–µ–ª–∏ (96 —Ñ–∞–π–ª–æ–≤)..."
echo "========================================"

# –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –¶–ò–ö–õ: {1..96} –≤–º–µ—Å—Ç–æ {001..096}
# printf –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ (1 -> 00001, 96 -> 00096)
for i in {1..96}; do
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞: model-00001-of-00096.safetensors
    FILE_NAME=$(printf "model-%05d-of-00096.safetensors" "$i")
    FILE_URL="https://huggingface.co/$MODEL_ID/resolve/main/$FILE_NAME"
    
    do_download "$FILE_URL" "$FILE_NAME"
done

echo "‚úÖ –ß–∞—Å—Ç—å 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –í—Å–µ –≤–µ—Å–∞ —Å–∫–∞—á–∞–Ω—ã."

# ---------------------------------------------------------
# –ß–ê–°–¢–¨ 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# ---------------------------------------------------------
echo "========================================"
echo "‚¨áÔ∏è  –ß–ê–°–¢–¨ 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –¢–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä..."
echo "========================================"

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
CONFIG_FILES=(
    "config.json"
    "generation_config.json"
    "model.safetensors.index.json"
    "preprocessor_config.json"
    "tokenizer.json"
    "tokenizer_config.json"
    "video_preprocessor_config.json"
    "vocab.json"
    "merges.txt"
    "chat_template.json"
)

for file in "${CONFIG_FILES[@]}"; do
    FILE_URL="https://huggingface.co/$MODEL_ID/resolve/main/$file"
    do_download "$FILE_URL" "$file"
done

echo "‚úÖ –ß–∞—Å—Ç—å 2 –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∫–∞—á–∞–Ω—ã."

# ---------------------------------------------------------
# –ò–¢–û–ì–ò
# ---------------------------------------------------------
echo ""
echo "========================================"
echo "üéâ –°–ö–ê–ß–ò–í–ê–ù–ò–ï –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û!"
echo "========================================"
echo "üìÇ –ü—É—Ç—å: $TARGET_DIR"
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤–µ—Å–æ–≤ (–ø–µ—Ä–≤—ã–µ 5):"
ls -lh model-*.safetensors | head -5
echo "..."
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤–µ—Å–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5):"
ls -lh model-*.safetensors | tail -5
echo ""
echo "üìã –í—Å–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ:"
ls -lh