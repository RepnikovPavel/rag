#!/usr/bin/env bash
# download_llama3.2_90b_vision.sh - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ meta-llama/Llama-3.2-90B-Vision-Instruct
# –í–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ç–æ–∫–µ–Ω–∞ –¥–ª—è gated –º–æ–¥–µ–ª–µ–π

set -euo pipefail

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
MODEL_ID="meta-llama/Llama-3.2-90B-Vision-Instruct"
# –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å ~180 –ì–ë –º–µ—Å—Ç–∞)
TARGET_DIR="/mnt/nvme/huggingface/Llama-3.2-90B-Vision-Instruct"

# –í–ê–ñ–ù–û: –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–æ—à–∏–±–∫–∞ 403), –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à HF Token:
# –ü—Ä–∏–º–µ—Ä: HF_TOKEN="hf_xxxxxxxxxxxxxxxxxxxxxxx"
HF_TOKEN=""

echo "üöÄ –°–∫–∞—á–∏–≤–∞–µ–º $MODEL_ID"
echo "üìÇ –ü–∞–ø–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: $TARGET_DIR"
echo "‚ö†Ô∏è  –ú–æ–¥–µ–ª—å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 37 —á–∞—Å—Ç–µ–π, –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä ~175 –ì–ë."

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É
mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç–æ–∫–µ–Ω–∞ –∏ –¥–æ–∫–∞—á–∫–∏
do_download() {
    local url="$1"
    local filename="$2"
    
    echo "üì• –°–∫–∞—á–∏–≤–∞—é: $filename"
    
    # –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã wget
    WGET_CMD="wget -c --timeout=3600 --tries=3 --continue --user-agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'"
    
    # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —É–∫–∞–∑–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if [[ -n "$HF_TOKEN" ]]; then
        WGET_CMD="$WGET_CMD --header='Authorization: Bearer $HF_TOKEN'"
    fi
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
    eval $WGET_CMD -O "$filename" "$url" || {
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è $filename."
        if [[ -z "$HF_TOKEN" ]]; then
            echo "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å HF_TOKEN –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞. –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç–æ–π (gated)."
        fi
        return 1
    }
}

# ---------------------------------------------------------
# –ß–ê–°–¢–¨ 1: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–µ—Å–æ–≤ (37 —Ñ–∞–π–ª–æ–≤ safetensors)
# ---------------------------------------------------------
echo "========================================"
echo "‚¨áÔ∏è  –ß–ê–°–¢–¨ 1: –í–µ—Å–∞ –º–æ–¥–µ–ª–∏ (37 —Ñ–∞–π–ª–æ–≤)..."
echo "========================================"

# –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –¶–ò–ö–õ: {1..37} –≤–º–µ—Å—Ç–æ {001..037}
# printf —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç 1 –∫–∞–∫ 00001, 37 –∫–∞–∫ 00037, —á—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –≤–æ—Å—å–º–µ—Ä–∏—á–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏
for i in {1..37}; do
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞: model-00001-of-00037.safetensors
    FILE_NAME=$(printf "model-%05d-of-00037.safetensors" "$i")
    FILE_URL="https://huggingface.co/$MODEL_ID/resolve/main/$FILE_NAME"
    
    do_download "$FILE_URL" "$FILE_NAME"
done

echo "‚úÖ –ß–∞—Å—Ç—å 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –í—Å–µ –≤–µ—Å–∞ —Å–∫–∞—á–∞–Ω—ã."

# ---------------------------------------------------------
# –ß–ê–°–¢–¨ 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# ---------------------------------------------------------
echo "========================================"
echo "‚¨áÔ∏è  –ß–ê–°–¢–¨ 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –¢–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä, Vision..."
echo "========================================"

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
CONFIG_FILES=(
    "config.json"
    "generation_config.json"
    "model.safetensors.index.json"
    "preprocessor_config.json"
    "tokenizer.json"
    "tokenizer_config.json"
    "special_tokens_map.json"
    "chat_template.json"
    "README.md"
    "LICENSE.txt"
    "USE_POLICY.md"
    ".gitattributes"
)

for file in "${CONFIG_FILES[@]}"; do
    FILE_URL="https://huggingface.co/$MODEL_ID/resolve/main/$file"
    do_download "$FILE_URL" "$file"
done

echo "‚úÖ –ß–∞—Å—Ç—å 2 –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∫–∞—á–∞–Ω—ã."

# ---------------------------------------------------------
# –ò–¢–û–ì–ò
# ---------------------------------------------------------
echo ""
echo "========================================"
echo "üéâ –°–ö–ê–ß–ò–í–ê–ù–ò–ï –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û!"
echo "========================================"
echo "üìÇ –ü—É—Ç—å: $TARGET_DIR"
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤–µ—Å–æ–≤ (–ø–µ—Ä–≤—ã–µ 5):"
ls -lh model-*.safetensors | head -5
echo "..."
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤–µ—Å–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5):"
ls -lh model-*.safetensors | tail -5
echo ""
echo "üìã –í—Å–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ:"
ls -lh