#!/usr/bin/env bash
# download_qwen2_vl_72b.sh - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Qwen/Qwen2-VL-72B-Instruct
# –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ç–æ—á–Ω–æ–º —Å–ø–∏—Å–∫–µ —Ñ–∞–π–ª–æ–≤ (38 —à–∞—Ä–¥_weights + –∫–æ–Ω—Ñ–∏–≥–∏)

set -euo pipefail

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
MODEL_ID="Qwen/Qwen2-VL-72B-Instruct"
# –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å ~150 –ì–ë –º–µ—Å—Ç–∞)
TARGET_DIR="/mnt/nvme/huggingface/Qwen2-VL-72B-Instruct"

echo "üöÄ –°–∫–∞—á–∏–≤–∞–µ–º $MODEL_ID"
echo "üìÇ –ü–∞–ø–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: $TARGET_DIR"
echo "‚ö†Ô∏è  –ú–æ–¥–µ–ª—å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 38 —á–∞—Å—Ç–µ–π, –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä ~145 –ì–ë."

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É
mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–æ–∫–∞—á–∫–∏
do_download() {
    local url="$1"
    local filename="$2"
    
    echo "üì• –°–∫–∞—á–∏–≤–∞—é: $filename"
    
    # Wget —Å –¥–æ–∫–∞—á–∫–æ–π (-c), —Ç–∞–π–º–∞—É—Ç–æ–º –∏ 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    wget -c --timeout=3600 --tries=3 --continue \
         --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
         -O "$filename" "$url" || {
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è $filename. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞."
        return 1
    }
}

# ---------------------------------------------------------
# –ß–ê–°–¢–¨ 1: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–µ—Å–æ–≤ (38 —Ñ–∞–π–ª–æ–≤ safetensors)
# ---------------------------------------------------------
echo "========================================"
echo "‚¨áÔ∏è  –ß–ê–°–¢–¨ 1: –í–µ—Å–∞ –º–æ–¥–µ–ª–∏ (38 —Ñ–∞–π–ª–æ–≤)..."
echo "========================================"

# –¶–∏–∫–ª –æ—Ç 001 –¥–æ 038 (Qwen2-VL —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ 38 —á–∞—Å—Ç–µ–π)
for i in {001..038}; do
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞: model-00001-of-00038.safetensors
    FILE_NAME=$(printf "model-%05d-of-00038.safetensors" "$i")
    FILE_URL="https://huggingface.co/$MODEL_ID/resolve/main/$FILE_NAME"
    
    do_download "$FILE_URL" "$FILE_NAME"
done

echo "‚úÖ –ß–∞—Å—Ç—å 1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –í—Å–µ –≤–µ—Å–∞ —Å–∫–∞—á–∞–Ω—ã."

# ---------------------------------------------------------
# –ß–ê–°–¢–¨ 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# ---------------------------------------------------------
echo "========================================"
echo "‚¨áÔ∏è  –ß–ê–°–¢–¨ 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –¢–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä, VL-–ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥..."
echo "========================================"

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
CONFIG_FILES=(
    "config.json"
    "generation_config.json"
    "model.safetensors.index.json"
    "preprocessor_config.json" # –í–∞–∂–Ω–æ –¥–ª—è Vision-Language –º–æ–¥–µ–ª–∏
    "tokenizer.json"
    "tokenizer_config.json"
    "vocab.json"
    "merges.txt"      # –í–∞–∂–Ω–æ –¥–ª—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞
    "chat_template.json" # –®–∞–±–ª–æ–Ω —á–∞—Ç–∞
    "README.md"
    "LICENSE"
)

for file in "${CONFIG_FILES[@]}"; do
    FILE_URL="https://huggingface.co/$MODEL_ID/resolve/main/$file"
    do_download "$FILE_URL" "$file"
done

echo "‚úÖ –ß–∞—Å—Ç—å 2 –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∫–∞—á–∞–Ω—ã."

# ---------------------------------------------------------
# –ò–¢–û–ì–ò
# ---------------------------------------------------------
echo ""
echo "========================================"
echo "üéâ –°–ö–ê–ß–ò–í–ê–ù–ò–ï –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û!"
echo "========================================"
echo "üìÇ –ü—É—Ç—å: $TARGET_DIR"
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤–µ—Å–æ–≤ (–ø–µ—Ä–≤—ã–µ 5):"
ls -lh model-*.safetensors | head -5
echo "..."
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤–µ—Å–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5):"
ls -lh model-*.safetensors | tail -5
echo ""
echo "üìã –í—Å–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ:"
ls -lh